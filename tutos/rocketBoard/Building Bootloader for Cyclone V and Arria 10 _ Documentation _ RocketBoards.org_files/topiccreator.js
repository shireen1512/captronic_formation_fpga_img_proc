"use strict";(function(e){function t(t,i){var n=this;n.template="newtopic";n.steps=[{id:".tcTopicTypes",select:".tcTopicType"},{id:".tcTopicTemplates",expand:"topiccreator::topictemplates",select:".tcTopicTemplate"},{id:".tcInputForm",expand:"topiccreator::inputform"}];n.elem=e(t);n.container=n.elem.find(".tcContainer");n.opts=e.extend({topic:foswiki.getPreference("WEB")+"."+foswiki.getPreference("TOPIC")},n.elem.data(),i);n.elem.find(".tcNavi").on("click",function(){var t=e(this).attr("href");if(t==="#next"){n.gotoStep(n.currentStep+1,1)}else if(t==="#prev"){n.gotoStep(n.currentStep-1,-1)}else{console.error("unknown target ",t,"clicking on ",this)}return false});n.elem.find(".tcAbort").on("click",function(){e(this).parents(".ui-dialog-content:first").dialog("close");return false});n.elem.find(".tcSubmit").on("click",function(){n.container.block({message:""});n.elem.find("form").submit();return false});var o=n.steps[0],r=n.container.find(o.id),s=r.find(o.select+".tcSelected");if(s.length){o.selectedElem=s}n.gotoStep(0,1)}t.prototype.log=function(){var t=e.makeArray(arguments);t.unshift("TC:")};t.prototype.gotoStep=function(t,i){var n=this,o={},r=n.steps[t],s;n.log("called gotoStep",t,"dir=",i);if(t<0||t>n.steps.length||typeof r==="undefined"){console.error("unknown step "+t);return}n.currentStep=t;for(s=0;s<t;s++){if(n.steps[s].selectedElem){e.extend(o,n.steps[s].selectedElem.data())}else{n.log("no selected element in step",s)}}o["topicTitle"]=n.elem.find("input[name=topicTitle]").val();if(t===0||i<0){for(s=t;s<n.steps.length;s++){if(n.steps[s].expand){n.log("removing ",n.steps[s].id);n.elem.find(n.steps[s].id).remove();delete n.steps[s].selectedElem}}}if(r.expand&&n.container.find(r.id).length===0){n.container.block({message:""});e.extend(o,n.opts,{name:n.template,expand:r.expand,success:function(e){n.container.unblock();n.container.append(e);n.initStep(t,i)},error:function(e){console.error("Error: "+e.status+" "+e.statusText)}});foswiki.loadTemplate(o)}else{n.initStep(t,i)}};t.prototype.initStep=function(t,i){var n=this,o=n.steps[t],r=n.container.find(o.id),s=r.find(o.select),c=false,l;n.log("called initStep() - step=",t,"stepDesc=",o,"currentStep=",n.currentStep,"dir=",i);if(r.length&&s.length!==1){n.log("got something to select");n.elem.find(".tcViewPort").scrollTo(o.id,250)}else{n.log("nothing to select ... next");o.isHidden=true;r.hide();return n.gotoStep(n.currentStep+i,i)}for(l=t-1;l>=0;l--){if(!n.steps[l].isHidden){c=true}}if(!c){n.elem.find(".tcNaviPrev").parent().hide()}else{n.elem.find(".tcNaviPrev").parent().show()}if(t===n.steps.length-1){n.elem.find(".tcNaviNext").parent().hide();n.elem.find(".tcAbort, .tcSubmit").show()}else{n.elem.find(".tcNaviNext").parent().show();n.elem.find(".tcAbort, .tcSubmit").hide()}if(t===2){if(n.steps[1].selectedElem&&n.steps[1].selectedElem.data("topicTemplate")){n.container.find(o.id).find("input[name='templatetopic']").val(n.steps[1].selectedElem.data("topicTemplate"))}}window.setTimeout(function(){r.find("input[type=text]:first").focus()});if(r.data("inited")){n.log("element already inited",o.id);return}r.data("inited",1);n.log("init ",o.id);r.find("input[type=text]:not(.jqTextboxList)").on("keyup",function(e){var t;if(e.keyCode===13){t=n.elem.find("form");if(t.length){n.container.block({message:""});t.submit()}else{n.gotoStep(n.currentStep+1,1)}return false}});r.on("keydown",function(e){var t=r.find(".tcSelected"),i=r.find(".tcPage"),n,s,c;if(t.length==0){return}switch(e.keyCode){case 39:c=t.next();break;case 40:c=t.next().next().next();break;case 37:c=t.prev();break;case 38:c=t.prev().prev().prev();break}if(c&&c.length){t.removeClass("tcSelected");c.addClass("tcSelected");o.selectedElem=c;n=i.offset();s=c.offset();if(s.top+c.outerHeight()>n.top+i.innerHeight()||s.top<n.top){r.find(".tcPage").scrollTo(c,250)}return false}});if(o.select){s.on("click",function(){var t=e(this);s.removeClass("tcSelected");t.addClass("tcSelected");o.selectedElem=t;n.log("selected",t.data());n.gotoStep(n.currentStep+1,1);return false})}r.find("input.tcFilter").on("keyup",function(){var t=e(this).val().toLowerCase();s.each(function(){var i=e(this),n=i.text().toLowerCase();if(n.indexOf(t)>=0){i.show()}else{i.hide()}})})};e.fn.topicCreator=function(i){return this.each(function(){if(!e.data(this,"topicCreator")){e.data(this,"topicCreator",new t(this,i))}})};e(".jqTopicCreator:not(.jqInitedTopicCreator)").livequery(function(){e(this).addClass("jqInitedTopicCreator").topicCreator()})})(jQuery);